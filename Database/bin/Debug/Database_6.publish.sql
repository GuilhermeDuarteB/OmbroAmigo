/*
Deployment script for db-ombro-amigo

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "db-ombro-amigo"
:setvar DefaultFilePrefix "db-ombro-amigo"
:setvar DefaultDataPath ""
:setvar DefaultLogPath ""

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
PRINT N'Rename refactoring operation with key 54c9e21c-58c8-4e5b-8e17-40edba1713a3 is skipped, element [dbo].[Subscricoes].[S´] (SqlSimpleColumn) will not be renamed to CicloSubscricao';


GO
PRINT N'Rename refactoring operation with key 80c4af79-de5b-4175-8788-d4784721996f is skipped, element [dbo].[Subscricoes].[price] (SqlSimpleColumn) will not be renamed to Preco';


GO
PRINT N'Rename refactoring operation with key bf36aae4-3f85-4540-ae43-bf3acb70c23c is skipped, element [dbo].[Subscricoes].[created_at] (SqlSimpleColumn) will not be renamed to DataInicio';


GO
PRINT N'Rename refactoring operation with key 3e691094-e5d1-4711-880d-df8542d5c267 is skipped, element [dbo].[Subscricoes].[updated_at] (SqlSimpleColumn) will not be renamed to UpdateSubscricao';


GO
PRINT N'Altering Table [dbo].[Utilizadores]...';


GO
ALTER TABLE [dbo].[Utilizadores]
    ADD [IdSubscricao] INT NULL;


GO
PRINT N'Creating Table [dbo].[Pagamentos]...';


GO
CREATE TABLE [dbo].[Pagamentos] (
    [IdPagamento]         INT             IDENTITY (1, 1) NOT NULL,
    [IdSubscricaoUsuario] INT             NOT NULL,
    [IdUtilizador]        INT             NOT NULL,
    [Valor]               DECIMAL (10, 2) NOT NULL,
    [DataPagamento]       DATETIME        NULL,
    [MetodoPagamento]     NVARCHAR (50)   NOT NULL,
    [Estado]              NVARCHAR (50)   NOT NULL,
    [DataCriacao]         DATETIME        NULL,
    [DataAtualizacao]     DATETIME        NULL,
    PRIMARY KEY CLUSTERED ([IdPagamento] ASC)
);


GO
PRINT N'Creating Table [dbo].[SubscricaoPorUtilizador]...';


GO
CREATE TABLE [dbo].[SubscricaoPorUtilizador] (
    [IdSubscricaoUsuario] INT           IDENTITY (1, 1) NOT NULL,
    [IdUtilizador]        INT           NOT NULL,
    [IdSubscricao]        INT           NOT NULL,
    [Status]              NVARCHAR (50) NOT NULL,
    [DataInicio]          DATETIME      NOT NULL,
    [DataFim]             DATETIME      NULL,
    [DataCriacao]         DATETIME      NULL,
    [DataAtualizacao]     DATETIME      NULL,
    PRIMARY KEY CLUSTERED ([IdSubscricaoUsuario] ASC)
);


GO
PRINT N'Creating Table [dbo].[Subscricoes]...';


GO
CREATE TABLE [dbo].[Subscricoes] (
    [IdSubscricao]     INT             IDENTITY (1, 1) NOT NULL,
    [NomeSubscricao]   NVARCHAR (255)  NOT NULL,
    [Preco]            DECIMAL (10, 2) NOT NULL,
    [CicloSubscricao]  NVARCHAR (50)   NOT NULL,
    [Vantagens]        NVARCHAR (MAX)  NOT NULL,
    [DataInicio]       DATETIME        NULL,
    [UpdateSubscricao] DATETIME        NULL,
    PRIMARY KEY CLUSTERED ([IdSubscricao] ASC)
);


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[Pagamentos]...';


GO
ALTER TABLE [dbo].[Pagamentos]
    ADD DEFAULT GETDATE() FOR [DataPagamento];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[Pagamentos]...';


GO
ALTER TABLE [dbo].[Pagamentos]
    ADD DEFAULT GETDATE() FOR [DataCriacao];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[Pagamentos]...';


GO
ALTER TABLE [dbo].[Pagamentos]
    ADD DEFAULT GETDATE() FOR [DataAtualizacao];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[SubscricaoPorUtilizador]...';


GO
ALTER TABLE [dbo].[SubscricaoPorUtilizador]
    ADD DEFAULT GETDATE() FOR [DataInicio];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[SubscricaoPorUtilizador]...';


GO
ALTER TABLE [dbo].[SubscricaoPorUtilizador]
    ADD DEFAULT GETDATE() FOR [DataCriacao];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[SubscricaoPorUtilizador]...';


GO
ALTER TABLE [dbo].[SubscricaoPorUtilizador]
    ADD DEFAULT GETDATE() FOR [DataAtualizacao];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[Subscricoes]...';


GO
ALTER TABLE [dbo].[Subscricoes]
    ADD DEFAULT GETDATE() FOR [DataInicio];


GO
PRINT N'Creating Default Constraint unnamed constraint on [dbo].[Subscricoes]...';


GO
ALTER TABLE [dbo].[Subscricoes]
    ADD DEFAULT GETDATE() FOR [UpdateSubscricao];


GO
PRINT N'Creating Foreign Key unnamed constraint on [dbo].[Pagamentos]...';


GO
ALTER TABLE [dbo].[Pagamentos] WITH NOCHECK
    ADD FOREIGN KEY ([IdSubscricaoUsuario]) REFERENCES [dbo].[SubscricaoPorUtilizador] ([IdSubscricaoUsuario]);


GO
PRINT N'Creating Foreign Key unnamed constraint on [dbo].[Pagamentos]...';


GO
ALTER TABLE [dbo].[Pagamentos] WITH NOCHECK
    ADD FOREIGN KEY ([IdUtilizador]) REFERENCES [dbo].[Utilizadores] ([Id]);


GO
PRINT N'Creating Foreign Key unnamed constraint on [dbo].[SubscricaoPorUtilizador]...';


GO
ALTER TABLE [dbo].[SubscricaoPorUtilizador] WITH NOCHECK
    ADD FOREIGN KEY ([IdUtilizador]) REFERENCES [dbo].[Utilizadores] ([Id]);


GO
PRINT N'Creating Foreign Key unnamed constraint on [dbo].[SubscricaoPorUtilizador]...';


GO
ALTER TABLE [dbo].[SubscricaoPorUtilizador] WITH NOCHECK
    ADD FOREIGN KEY ([IdSubscricao]) REFERENCES [dbo].[Subscricoes] ([IdSubscricao]);


GO
PRINT N'Creating Foreign Key [dbo].[FK_Utilizadores_ToTable]...';


GO
ALTER TABLE [dbo].[Utilizadores] WITH NOCHECK
    ADD CONSTRAINT [FK_Utilizadores_ToTable] FOREIGN KEY ([IdSubscricao]) REFERENCES [dbo].[Subscricoes] ([IdSubscricao]);


GO
PRINT N'Creating Check Constraint unnamed constraint on [dbo].[Pagamentos]...';


GO
ALTER TABLE [dbo].[Pagamentos] WITH NOCHECK
    ADD CHECK (MetodoPagamento IN ('cartao_credito', 'mbway', 'paypal'));


GO
PRINT N'Creating Check Constraint unnamed constraint on [dbo].[Pagamentos]...';


GO
ALTER TABLE [dbo].[Pagamentos] WITH NOCHECK
    ADD CHECK (Estado IN ('sucesso', 'falha', 'pendente'));


GO
PRINT N'Creating Check Constraint unnamed constraint on [dbo].[SubscricaoPorUtilizador]...';


GO
ALTER TABLE [dbo].[SubscricaoPorUtilizador] WITH NOCHECK
    ADD CHECK (Status IN ('Ativa', 'Expirada', 'Cancelada'));


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '54c9e21c-58c8-4e5b-8e17-40edba1713a3')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('54c9e21c-58c8-4e5b-8e17-40edba1713a3')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '80c4af79-de5b-4175-8788-d4784721996f')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('80c4af79-de5b-4175-8788-d4784721996f')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'bf36aae4-3f85-4540-ae43-bf3acb70c23c')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('bf36aae4-3f85-4540-ae43-bf3acb70c23c')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '3e691094-e5d1-4711-880d-df8542d5c267')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('3e691094-e5d1-4711-880d-df8542d5c267')

GO

GO
